\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{uclaling}[2018/10/02 Package for UCLA Linguistics documents.]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Font Options
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{fontspec}
\RequirePackage{lastpage}
\RequirePackage{fancyhdr}
\RequirePackage{setspace}
\RequirePackage{amsmath}
\RequirePackage{xltxtra}
\RequirePackage{unicode-math}
\RequirePackage{ifthen}
\RequirePackage[patch,debugshow]{kvoptions}

\SetupKeyvalOptions{
  family=LING,
  prefix=LING@
}

%% Font Options
\DeclareBoolOption{sans}
\DeclareBoolOption{libertine}
\DeclareBoolOption{times}
\DeclareBoolOption{roman}
\DeclareBoolOption{lmodern}
\DeclareBoolOption{stix}

\DeclareStringOption{coursename}
\DeclareStringOption{profname}
\DeclareStringOption{coursenumber}
\DeclareStringOption{duedate}
\DeclareStringOption[]{style}

\DeclareBoolOption{homework}
\DeclareBoolOption{squib}
\DeclareStringOption{assignment}

\ProcessKeyvalOptions*

\newcommand*{\uclaling@DisableOption}[2]{
  \DisableKeyvalOption[
    action={#1},
    package=uclaling
  ]{LING}{#2}
}

\newboolean{uselibertine}

\ifxetex
\RequirePackage{stoneipa}
\newcommand\ipa[1]{{\sipafont #1}}
\fi

\ifLING@sans % 'sans' option
  \renewcommand{\familydefault}{\sfdefault}
\fi

\ifLING@times % 'times' option
  \setmainfont{Times New Roman}
  \setboolean{uselibertine}{false}
\fi
\ifLING@roman % 'roman' option
  \renewcommand{\familydefault}{\rmdefault}
  \setboolean{uselibertine}{false}
\fi
\ifLING@stix % 'stix' option
  \setboolean{uselibertine}{false}

  \setmonofont{Latin Modern Mono Light}[
    SmallCapsFont = {Latin Modern Mono Caps}
  ]
  % Set the math font to Stix Two Math.
  \setmathfont{STIX2Math}[
    Extension = .otf,
  ]
  % Set the main font to Stix Two Text
  \setmainfont{STIX2Text}[
    Extension      = .otf,
    UprightFont    = *-Regular,
    BoldFont       = *-Bold,
    ItalicFont     = *-Italic,
    BoldItalicFont = *-BoldItalic
  ]
\fi
\ifLING@libertine % 'libertine' option
  \RequirePackage[p]{libertine}
  % See  Manual for Linux Libertine with XeTeX
  % http://linuxlibertine.sourceforge.net/Libertine-XeTex-EN.pdf
  \ifxetex
    % Loads fontspec, metalogo, and realscripts packages
    % Might be unnecessary with a modern XeTeX so
    % commenting out for now.
    \RequirePackage{xltxtra}
    % Convert accent-glyph sequences to single Unicode characters
    \RequirePackage{xunicode}
    % Recommended configuration for compatible mathematics
    % XeLaTeX. From Section 6 - Concluding Remarks (p. 5) of the
    % the libertine package manual.
    \setmathfont[Scale=MatchUppercase]{libertinusmath-regular.otf}
    \renewcommand{\baselinestretch}{1.15}
    % set the main font to Linux Libertine
    \setmainfont[Ligatures={Common,TeX}]{Linux Libertine}
    % TODO set sans font to Linux Biolinum
    % TODO set mono font to Linux Mono
    % For now, using Latin Modern Mono as a replacement.
    % Set the monospace font to Latin Modern
    \setmonofont{Latin Modern Mono Light}[
      SmallCapsFont = {Latin Modern Mono Caps}
    ]

    \RequirePackage[supstfm=libertinesups,supscaled=1.125,raised=0em]{superiors}
    \renewcommand{\baselinestretch}{1.15}
  \else
    % Recommended math font for xtmath
    % \RequirePackage[libertine]{newxtmath}
    % Typographic extensions for PdfTeX
    \RequirePackage{microtype}
  \fi
\fi

 % Problem environment
\newcounter{problem}[section]
\setcounter{problem}{0}

\newenvironment{problem}[1][]%
  {\refstepcounter{problem}\par\medskip
    \begin{flushright}\framebox[0.2\textwidth][r]{\textbf{\theproblem}}\rmfamily\end{flushright}
  }
  {\medskip}%

\def\uclalingassignment{}
 \unless\ifx\LING@assignment\@empty
   \renewcommand{\uclalingassignment}{\LING@assignment}
 \fi
\def\uclalingcoursename{}
\unless\ifx\LING@coursename\@empty
  \renewcommand{\uclalingcoursename}{\LING@coursename}
\fi
\def\uclalingprofname{}
\unless\ifx\LING@profname\@empty
  \renewcommand{\uclalingprofname}{\LING@profname}
\fi
\def\uclalingcoursenumber{}
\unless\ifx\LING@coursenumber\@empty
 \renewcommand{\uclalingcoursenumber}{\LING@coursenumber}
\fi
% Use Month Day, Year format
\def\uclalingduedate{}
\unless\ifx\LING@duedate\@empty
  \renewcommand{\uclalingduedate}{\LING@duedate}
\fi


% Opinionated formatting for LaTeX documents
%  in the format of UCLA syntax professor
%  Ethan Poole.
% Create a header rule with variable height.
% From https://tex.stackexchange.com/a/17130
\newcommand*\titlehrule[1][0.4pt]{%
  \leavevmode\leaders\hrule height#1\hfill\kern0pt
}
\renewcommand{\thesection}{\arabic{section}}

\ifthenelse{\equal{\LING@style}{epoole}}{%
  \RequirePackage{pifont}
  \RequirePackage{xspace}
  % Text area dimensions.
  \settypeblocksize{7.75in}{32pc}{*}
  \setlrmargins{*}{*}{1}
  \setulmargins{*}{*}{1}
  \checkandfixthelayout
  \raggedbottom

 \RequirePackage[bottom,hang,multiple,norule]{footmisc}
 \renewcommand{\footnotemargin}[0]{1.25em}


  \pagestyle{fancyplain}
  \renewcommand{\headrulewidth}{0mm}%
  \fancyhf{} % Clear header
  \rfoot{\itshape Page {\thepage} of \pageref{LastPage}} % Page X of Y

  \ifthenelse{\boolean{LING@homework}}{% epoole homework style
    \renewcommand{\maketitle}{%
      \setlength{\parindent}{0pt}
      {\huge \bfseries\@title}\hfill
      \@author\\
      \noindent\titlehrule[0.8 mm] % Use a 0.8mm tick header rule.
      \begin{flushright}
        \unless\ifx\uclalingprofname\@empty
          \textbf{\uclalingprofname} \\
        \fi
        \unless\ifx\uclalingcoursename\@empty
          \textbf{\uclalingcoursename} \\
        \fi
        \textbf{Due: \uclalingduedate}
      \end{flushright}
    }
  }{% 'epoole' non-homework option
     % A font option was specified. Allow
     % overriding libertine as the default font
     % when the 'homework' option was not given.
     % \ifthenelse{\boolean{uselibertine}}{}{%
     %   \uclaling@DisableOption{undef}{libertine}
     % }

   \renewcommand{\maketitle}{%
     \setlength{\parindent}{0pt}
     % Left Header
     {\LARGE \bfseries\@title}\\\smallskip
     \noindent\titlehrule[0.4mm]
     \begin{flushright}
       \@author \\
       \unless\ifx\uclalingassignment\@empty
         \uclalingassignment \\
       \fi
       {\scshape \uclalingcoursenumber} :  \uclalingcoursename \\
       \uclalingduedate
     \end{flushright}
   }
 }
}{%
\ifthenelse{\equal{\LING@style}{phonetics}}{%
  % \RequirePackage{vocaltract} % vocal tract animation
  \RequirePackage{phonetic} % Phonetics macros
  \RequirePackage{phonrule}
  \RequirePackage{phonenumbers}
  \RequirePackage{ipaex-type1}

  \def\phonesubtitle{}

  \unless\ifx\uclalingcoursenumber\@empty
  \def\phonesubtitle{\uclalingcoursenumber}
  \fi

  \unless\ifx\uclalingcoursenumber\@empty
  \let\oldphonesubtitle\phonesubtitle
  \def\phonesubtitle{\oldphonesubtitle -- \uclalingcoursename}
  \fi

  \renewcommand{\maketitle}{%
    \setlength{\parindent}{0pt}
    {\LARGE \@title} \\
    \unless\ifx\phonesubtitle\@empty
    {\large \itshape \phonesubtitle} \\
    \fi \medskip
    \noindent\titlehrule[0.4mm]
      \begin{flushright}
        \@author \\
        \unless\ifx\uclalingcoursenumber\@empty
        \uclalingcoursenumber \\
        \fi
          \uclalingduedate
      \end{flushright}
    }
 }{}
}

\setlength{\parskip}{0.5\baselineskip plus2pt minus2pt}
\setlength{\parindent}{2pt}

\endinput
