\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{uclaling}[2018/10/02 Package for UCLA Linguistics documents.]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Font Options
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{fontspec}
\RequirePackage{lastpage}
\RequirePackage{fancyhdr}
\RequirePackage{setspace}
\RequirePackage{amsmath}
\RequirePackage{xltxtra}
\RequirePackage{unicode-math}
\RequirePackage{ifthen}
\RequirePackage[patch,debugshow]{kvoptions}

\SetupKeyvalOptions{
  family=LING,
  prefix=LING@
}

%% Font Options
\DeclareBoolOption{sans}
\DeclareBoolOption{libertine}
\DeclareBoolOption{times}
\DeclareBoolOption{roman}
\DeclareBoolOption{lmodern}
\DeclareBoolOption{stix}

\DeclareStringOption{coursename}
\DeclareStringOption{profname}
\DeclareStringOption{coursenumber}
\DeclareStringOption{duedate}
\DeclareStringOption[]{style}

\DeclareBoolOption{homework}
\DeclareBoolOption{squib}
\DeclareStringOption{assignment}

\ProcessKeyvalOptions*

\newcommand*{\uclaling@DisableOption}[2]{
  \DisableKeyvalOption[
    action={#1},
    package=uclaling
  ]{LING}{#2}
}

\newboolean{uselibertine}

\ifxetex
\RequirePackage{stoneipa}
\newcommand\ipa[1]{{\sipafont #1}}
\fi

\ifLING@sans % 'sans' option
  \renewcommand{\familydefault}{\sfdefault}
\fi

\ifLING@times % 'times' option
  \setmainfont{Times New Roman}
  \setboolean{uselibertine}{false}
\fi
\ifLING@roman % 'roman' option
  \renewcommand{\familydefault}{\rmdefault}
  \setboolean{uselibertine}{false}
\fi
\ifLING@stix % 'stix' option
  \setboolean{uselibertine}{false}
  % Set the math font to Stix Two Math.
  \setmathfont{STIX2Math}[
    Extension = .otf,
  ]
  % Set the main font to Stix Two Text
  \setmainfont{STIX2Text}[
    Extension      = .otf,
    UprightFont    = *-Regular,
    BoldFont       = *-Bold,
    ItalicFont     = *-Italic,
    BoldItalicFont = *-BoldItalic
  ]
\fi
\ifLING@libertine % 'libertine' option
  \RequirePackage[p]{libertine}
  % See  Manual for Linux Libertine with XeTeX
  % http://linuxlibertine.sourceforge.net/Libertine-XeTex-EN.pdf
  \ifxetex
    % Loads fontspec, metalogo, and realscripts packages
    % Might be unnecessary with a modern XeTeX so
    % commenting out for now.
    \RequirePackage{xltxtra}
    % Convert accent-glyph sequences to single Unicode characters
    \RequirePackage{xunicode}
    % Recommended configuration for compatible mathematics
    % XeLaTeX. From Section 6 - Concluding Remarks (p. 5) of the
    % the libertine package manual.
    \setmathfont[Scale=MatchUppercase]{libertinusmath-regular.otf}
    \renewcommand{\baselinestretch}{1.15}
    % set the main font to Linux Libertine
    \setmainfont[Ligatures={Common,TeX}]{Linux Libertine}
    % TODO set sans font to Linux Biolinum
    % TODO set mono font to Linux Mono
    % For now, using Latin Modern Mono as a replacement.
    % Set the monospace font to Latin Modern
    \setmonofont{Latin Modern Mono Light}[
      SmallCapsFont = {Latin Modern Mono Caps}
    ]
  \else
    % Recommended math font for xtmath
    % \RequirePackage[libertine]{newxtmath}
    % Typographic extensions for PdfTeX
    \RequirePackage{microtype}
  \fi
\fi

 % Problem environment
\newcounter{problem}[section]
\setcounter{problem}{0}

\newenvironment{problem}[1][]%
  {\refstepcounter{problem}\par\medskip
    \begin{flushright}\framebox[0.2\textwidth][r]{\textbf{\theproblem}}\rmfamily\end{flushright}
  }
  {\medskip}%

\def\uclalingassignment{}
 \unless\ifx\LING@assignment\@empty
   \renewcommand{\uclalingassignment}{\LING@assignment}
 \fi
\def\uclalingcoursename{}
\unless\ifx\LING@coursename\@empty
  \renewcommand{\uclalingcoursename}{\LING@coursename}
\fi
\def\uclalingprofname{}
\unless\ifx\LING@profname\@empty
  \renewcommand{\uclalingprofname}{\LING@profname}
\fi
\def\uclalingcoursenumber{}
\unless\ifx\LING@coursenumber\@empty
 \renewcommand{\uclalingcoursenumber}{\LING@coursenumber}
\fi
% Use Month Day, Year format
\def\uclalingduedate{}
\unless\ifx\LING@duedate\@empty
  \renewcommand{\uclalingduedate}{\LING@duedate}
\fi


% Opinionated formatting for LaTeX documents
%  in the format of UCLA syntax professor
%  Ethan Poole.
\ifthenelse{\equal{\LING@style}{epoole}}{%
  \RequirePackage{pifont}
  \RequirePackage{xspace}
  % Helpful short hands.
  \newcommand{\vP}[0]{\textit{v}P\xspace}
  \newcommand{\littlev}[0]{\textit{v}\xspace}

  % Data macros.
  \newcommand{\objlang}[2][]{\textit{#2}\ifx&#1&\else\ `#1'\fi}
  \newcommand{\ja}[0]{\ding{51}}
  % \newcommand{\lb}[2]{\ensuremath{[_\text{#1}\,\text{#2}\,]}}
  \newcommand{\gap}[0]{\rule[-1.25pt]{1.5em}{0.75pt}\,}
  \newcommand{\ind}[1]{\ensuremath{_{#1}}}

  % Features.
  \newcommand{\feature}[1]{{\scshape [#1]}}
  \newcommand{\mf}[1]{\feature{$\bullet$#1$\bullet$}}
  \newcommand{\hf}[1]{\feature{$+$#1$+$}}
    \newcommand{\agrf}[1]{\feature{$\star$#1$\star$}}

  % Satisfied features.
  \newcommand{\shf}[1]{\hf{#1}{\scriptsize\,\ja}}
  \newcommand{\smf}[1]{\mf{#1}{\scriptsize\,\ja}}
  \newcommand{\sagrf}[1]{\agrf{#1}{\scriptsize\,\ja}}

  % Phrase structure.
  \newcommand{\head}[1]{#1$^0$}
  \newcommand{\spec}[1]{\mbox{[Spec, #1]}}
  \newcommand{\comp}[1]{\mbox{[Comp, #1]}}
  \newcommand{\xbar}[1]{$\overline{\textrm{#1}}$}

  % Semantics.
  \newcommand{\denotation}[1]{\denotationbase{\text{#1}}}
  \newcommand{\denotationbase}[1]{\ensuremath{\left\lsem#1\right\rsem}}
  \newcommand{\startfn}[0]{\ensuremath{\ .\ }}
    
  % Text area dimensions.
  \settypeblocksize{7.75in}{32pc}{*}
  \setlrmargins{*}{*}{1}
  \setulmargins{*}{*}{1}
  \checkandfixthelayout
  \raggedbottom

 \RequirePackage[bottom,hang,multiple,norule]{footmisc}
 \renewcommand{\footnotemargin}[0]{1.25em}

  % Create a header rule with variable height.
  % From https://tex.stackexchange.com/a/17130
  \newcommand*\titlehrule[1][0.4pt]{%
    \leavevmode\leaders\hrule height#1\hfill\kern0pt
  }
  \pagestyle{fancyplain}
  \renewcommand{\headrulewidth}{0mm}%
  \fancyhf{} % Clear header
  \rfoot{\itshape Page {\thepage} of \pageref{LastPage}} % Page X of Y

  \ifthenelse{\boolean{LING@homework}}{% epoole homework style
    \renewcommand{\maketitle}{%
      \setlength{\parindent}{0pt}
      {\Large\@title}\hfill
      \@author\\
      \noindent\titlehrule[0.8 mm] % Use a 0.8mm tick header rule.
      \begin{flushright}
        \unless\ifx\uclalingprofname\@empty
          \textbf{\uclalingprofname} \\
        \fi
        \unless\ifx\uclalingcoursename\@empty
          \textbf{\uclalingcoursename} \\
        \fi
        \textbf{Due: \uclalingduedate}
      \end{flushright}
    }
  }{% 'epoole' non-homework option
     % A font option was specified. Allow
     % overriding libertine as the default font
     % when the 'homework' option was not given.
     % \ifthenelse{\boolean{uselibertine}}{}{%
     %   \uclaling@DisableOption{undef}{libertine}
     % }
      
   \renewcommand{\maketitle}{%
     \setlength{\parindent}{0pt}
     % Left Header
     {\Large \@title}\hfill  \@author \\
   
     \noindent\titlehrule[0.8mm]
     \begin{flushright}
       \unless\ifx\uclalingassignment\@empty
         \uclalingassignment \\
       \fi
       \unless\ifx\uclalingcoursename\@empty
         \textbf{\uclalingcoursename} \\
       \fi
       \uclalingduedate
     \end{flushright}
   }
 }
}{%
\ifthenelse{\equal{\LING@style}{phonetics}}{%
  % \RequirePackage{vocaltract} % vocal tract animation
  \RequirePackage{phonetic} % Phonetics macros
  \RequirePackage{phonrule}
  \RequirePackage{phonenumbers}
  \RequirePackage{ipaex-type1}
}{% no style option given
    \renewcommand{\maketitle}{%
      \setlength{\parindent}{0pt}
      {\LARGE \@title} \\\\\medskip
      \begin{flushright}
        \@author \\
        \unless\ifx\uclalingcoursenumber\@empty
          \uclalingcoursenumber \\
        \fi
          \uclalingduedate
      \end{flushright}
    }
  }
}
\setlength{\parskip}{0.5\baselineskip plus2pt minus2pt}
\setlength{\parindent}{2pt}

\endinput



